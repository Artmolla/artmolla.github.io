(()=>{"use strict";const e={flat:"Квартира",bungalow:"Бунгало",house:"Дом",palace:"Дворец"},t=document.querySelector("#card").content.querySelector(".popup"),r=(e,t)=>{const r=(e=Math.abs(e)%100)%10;return e>10&&e<20?t[2]:r>1&&r<5?t[1]:1===r?t[0]:t[2]},o=document.querySelector(".map__filters"),a=o.querySelector("#housing-type"),n=o.querySelector("#housing-price"),c=o.querySelector("#housing-rooms"),l=o.querySelector("#housing-guests"),s=o.querySelector("#housing-features"),i=document.querySelector(".ad-form"),u=(e,t,r)=>{"false"===r?e.querySelectorAll(t).forEach((e=>e.disabled=!0)):"true"===r&&e.querySelectorAll(t).forEach((e=>e.disabled=!1))};i.classList.add("ad-form--disabled"),o.classList.add("map__filters--disabled"),u(i,"input","false"),u(i,"select","false"),u(i,"button","false"),u(i,"textarea","false"),u(o,"input","false"),u(o,"select","false");const d=document.querySelector("#success").content.querySelector(".success"),p=document.querySelector("#error").content.querySelector(".error"),m=document.querySelector("#fetch-error").content.querySelector(".fetch-error"),y=(e,t)=>{e.appendChild(t);const r=()=>{t.remove(),t.removeEventListener("click",r)},o=e=>{"Escape"===e.key&&(t.remove(),window.removeEventListener("keydown",o))};t.addEventListener("click",r),window.addEventListener("keydown",o)},f=["gif","jpg","jpeg","png"],v=document.querySelector(".ad-form__field input[type=file]"),h=document.querySelector(".ad-form-header__preview img"),g=document.querySelector(".ad-form__upload input[type=file]"),S=document.querySelector(".ad-form__photo"),q=(e,t)=>{const r=e.files[0],o=r.name.toLowerCase();if(f.some((e=>o.endsWith(e)))){const e=new FileReader;e.addEventListener("load",(()=>{if("IMG"===t.tagName)t.src=e.result;else{const r=document.createElement("IMG");r.src=e.result,r.width="40",r.height="44",t.append(r)}})),e.readAsDataURL(r)}};v.addEventListener("change",(()=>q(v,h))),g.addEventListener("change",(()=>q(g,S)));const _=()=>{w.reset(),h.src="img/muffin-grey.svg",F.value=`${I.lat}, ${I.lng}`,V.min=0,V.placeholder=0,S.innerHTML="",o.reset()},E=document.querySelector("main"),b={bungalow:"0",flat:"1000",house:"5000",palace:"10000"},C={1:["1"],2:["1","2"],3:["1","2","3"],100:["0"]},k="invalid",w=document.querySelector(".ad-form"),$=document.querySelector("#title"),x=document.querySelector("#type"),V=document.querySelector("#price"),T=document.querySelector("#timein"),A=document.querySelector("#timeout"),M=document.querySelector("#room_number"),N=document.querySelector("#capacity"),j=document.querySelector(".ad-form__submit"),F=document.querySelector("#address"),D=document.querySelector(".ad-form__reset"),z=(e,t)=>{for(let r of t.children)C[e.value].includes(r.value)?(r.disabled=!1,r.selected=!0):r.disabled=!0},H=(e,t)=>{for(let r of t.children)r.value===e.value?r.selected=!0:r.selected=!1};z(M,N),$.addEventListener("input",(()=>{const e=$.value.length;e<30?$.setCustomValidity(`Добавьте еще ${30-e} символов`):e>100?$.setCustomValidity(`Слишком длинное описание, удалите ${e-100} символов`):$.setCustomValidity(""),$.reportValidity()})),x.addEventListener("change",(()=>{V.min=b[x.value],V.placeholder=b[x.value]})),T.addEventListener("change",(()=>{H(T,A)})),A.addEventListener("change",(()=>{H(A,T)})),M.addEventListener("change",(()=>{z(M,N)})),j.addEventListener("click",(()=>{var e;(e=V).value>=b[x.value]?(e.setCustomValidity(""),e.classList.remove(k)):(e.classList.add(k),e.setCustomValidity(`Минимальная цена для этого типа сoставляет ${b[x.value]}`)),(e=>{e.validity.valid?e.validity.valueMissing?e.setCustomValidity("Пожалуйста, заполните это поле"):e.value.tooShort?e.setCustomValidity("Описание слишком короткое минимальная длинна 30"):e.value.tooLong?e.setCustomValidity("Описание слишком длинное максимальная длинна 100"):(e.setCustomValidity(""),e.classList.remove(k)):e.classList.add(k),e.reportValidity()})($)})),w.addEventListener("submit",(e=>{e.preventDefault();(e=>{fetch("https://22.javascript.pages.academy/keksobooking",{method:"POST",body:e}).then((e=>{e.ok?(y(E,d.cloneNode(!0)),_()):y(E,p.cloneNode(!0))}))})(new FormData(e.target))})),w.addEventListener("reset",(()=>{R.setLatLng(I),setTimeout((()=>{F.value=`${I.lat}, ${I.lng}`}),0)}));const I={lat:35.6801,lng:139.7655},U=document.querySelector(".map"),G=L.map("map-canvas");G.on("load",(()=>{var e,t;i.classList.remove("ad-form--disabled"),o.classList.remove("map__filters--disabled"),u(i,"input","true"),u(i,"select","true"),u(i,"button","true"),u(i,"textarea","true"),e=e=>{W(e),u(o,"input","true"),u(o,"select","true"),o.addEventListener("change",(()=>{((e,t)=>{let r;return(...t)=>{const o=e.bind(void 0,...t);clearTimeout(r),r=setTimeout(o,500)}})((()=>{B(),W((e=>e.filter((e=>(e.offer.type===a.value||"any"===a.value)&&(e.offer.rooms===+c.value||"any"===c.value)&&(e.offer.guests===+l.value||"any"===l.value)&&(e=>{switch(n.value){case"low":return e.offer.price<=1e3;case"middle":return e.offer.price>=1e3&&e.offer.price<=5e4;case"high":return e.offer.price>=5e4;case"any":return e}})(e)&&(e=>[].map.call(s.querySelectorAll("input:checked"),(e=>e.value)).every((t=>e.offer.features.includes(t))))(e))))(e))}))()})),D.addEventListener("click",(()=>{_(),W(e)})),j.addEventListener("click",(()=>W(e)))},t=U,fetch("https://24.javascript.pages.academy/keksobooking/data").then((e=>e.json())).then((t=>{e(t)})).catch((e=>{t.appendChild((e=>{const t=m.cloneNode(!0);return t.querySelector(".fetch-error__message").textContent=e,t})(e))}))})),G.setView(I,10),L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:'&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'}).addTo(G);const O=L.icon({iconUrl:"img/main-pin.svg",iconSize:[38,95],iconAnchor:[22,94],popupAnchor:[-3,-76]}),P=L.icon({iconUrl:"img/pin.svg",iconSize:[38,95],iconAnchor:[22,94],popupAnchor:[-3,-76]}),R=L.marker(I,{draggable:!0,icon:O});F.value=`${I.lat}, ${I.lng}`,F.setAttribute("readonly","readonly"),R.on("dragend",(()=>{F.value=`${R.getLatLng().lat.toFixed(5)}, ${R.getLatLng().lng.toFixed(5)}`})),R.addTo(G);const W=o=>{o.slice(0,10).forEach((({author:o,offer:a,location:{lat:n,lng:c}})=>{L.marker({lat:n,lng:c},{keepInView:!0,icon:P}).addTo(G).bindPopup((({author:o,offer:a})=>{const n=t.cloneNode(!0);var c,l;return n.querySelector(".popup__title").textContent=a.title,n.querySelector(".popup__text--address").textContent=a.address,n.querySelector(".popup__text--price").textContent=`${a.price} ₽/ночь`,n.querySelector(".popup__type").textContent=e[a.type],n.querySelector(".popup__text--capacity").textContent=`${a.rooms} ${r(a.rooms,["комната","комнаты","комнат"])} для ${a.guests} ${r(a.guests,["гостя","гостей","гостей"])}`,n.querySelector(".popup__text--time").textContent=`Заезд после ${a.checkin} выезд до ${a.checkout}`,c=a.features,l=n.querySelector(".popup__features"),0===c.length?l.remove():(l.innerHTML="",c.forEach((e=>{const t=document.createElement("li");t.classList.add("popup__feature",`popup__feature--${e}`),l.appendChild(t)}))),n.querySelector(".popup__description").textContent=a.description,((e,t)=>{if(0===e.length)t.remove();else{const r=document.createDocumentFragment();e.forEach((e=>{const o=t.querySelector("img").cloneNode();o.src=e,r.appendChild(o)})),t.innerHTML="",t.appendChild(r)}})(a.photos,n.querySelector(".popup__photos")),n.querySelector(".popup__avatar").src=o.avatar,n})({author:o,offer:a}))}))},B=()=>{G.eachLayer((e=>{e instanceof L.Marker&&e!==R&&e.remove()}))}})();
//# sourceMappingURL=main.bundle.js.map